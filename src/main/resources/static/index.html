<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF预览服务器测试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-section {
            margin-bottom: 20px;
        }
        .editor-container {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            height: 300px;
        }
        .line-numbers {
            background-color: #f5f5f5;
            color: #666;
            padding: 10px 5px;
            text-align: right;
            border-right: 1px solid #ddd;
            overflow-y: hidden;
            overflow-x: hidden;
            user-select: none;
            min-width: 40px;
            white-space: pre;
            line-height: 22px;
            font-family: monospace;
        }
        .code-editor {
            flex-grow: 1;
            padding: 10px;
            overflow: auto;
            height: 100%;
        }
        textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            font-family: monospace;
            resize: none;
            padding: 0;
            margin: 0;
            line-height: 22px; /* 与行号区域保持一致 */
            white-space: pre; /* 禁用自动换行，保留空白字符 */
            overflow-x: auto; /* 启用水平滚动 */
            wrap: off; /* 禁用文本换行 */
        }
        .button-group {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #download-btn {
            background-color: #2196F3;
        }
        #download-btn:hover {
            background-color: #0b7dda;
        }
        .result-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 400px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            min-height: 500px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 4px;
            font-size: 14px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .search-container {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        .search-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            margin-right: 10px;
        }
        .search-buttons {
            display: flex;
        }
        .search-btn {
            padding: 8px 12px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }
        .search-btn:hover {
            background-color: #e0e0e0;
        }
        .search-btn.active {
            background-color: #2196F3;
            color: white;
        }
        .search-count {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF预览服务器测试工具</h1>
        
        <div class="input-section">
            <h3>JRXML 内容</h3>
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="搜索内容...">
                <div class="search-buttons">
                    <button id="search-btn" class="search-btn">搜索</button>
                    <button id="search-prev-btn" class="search-btn">上一个</button>
                    <button id="search-next-btn" class="search-btn">下一个</button>
                    <button id="search-case-btn" class="search-btn">Aa</button>
                </div>
                <div class="search-count" id="search-count"></div>
            </div>
            <div class="editor-container">
                <div class="line-numbers" id="line-numbers"></div>
                <div class="code-editor">
                    <textarea id="jrxml-content" placeholder="请粘贴JRXML内容..." spellcheck="false"></textarea>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="load-sample-btn">加载示例JRXML</button>
            <button id="generate-btn">生成PDF</button>
            <button id="download-btn" disabled>下载PDF</button>
        </div>
        
        <div class="status" id="status">准备就绪</div>
        
        <div class="result-section">
            <h3>PDF预览</h3>
            <iframe id="pdf-preview"></iframe>
        </div>
    </div>
    
    <script>
        const sampleJrxml = `<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 9.0.0.final using JasperReports Library version 6.21.0-4f56c4f36cd19e17675219a9ac4692d5f0f13b06  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="TrafficJobNormal" pageWidth="606" pageHeight="396" orientation="Landscape" columnWidth="566" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="NO_DATA_ADAPTER"/>
	<parameter name="REPORT_TIME" class="java.lang.String"/>
	<queryString language="SQL">
		<![CDATA[]]>
	</queryString>
	<field name="trafficNo" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="traffic_no"/>
		<property name="com.jaspersoft.studio.field.label" value="traffic_no"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="createTime" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="create_time"/>
		<property name="com.jaspersoft.studio.field.label" value="create_time"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="proposeStartTime" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="propose_start_time"/>
		<property name="com.jaspersoft.studio.field.label" value="propose_start_time"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="applyOrgName" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_org_name"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_org_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="applyUserName" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_user_name"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_user_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="applyUserPhone" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_user_phone"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_user_phone"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="fallbackContactUserName" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_fallback_user_name"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_fallback_user_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="fallbackContactUserPhone" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_fallback_user_phone"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_fallback_user_phone"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="reason" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="reason"/>
		<property name="com.jaspersoft.studio.field.label" value="reason"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="fromPlace" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="from_place"/>
		<property name="com.jaspersoft.studio.field.label" value="from_place"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="targetPlace" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="target_place"/>
		<property name="com.jaspersoft.studio.field.label" value="target_place"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="applyRemark" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_remark"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_remark"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="vehiclePlateNo" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="vehicle_plate_no"/>
		<property name="com.jaspersoft.studio.field.label" value="vehicle_plate_no"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="customNo" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="custom_no"/>
		<property name="com.jaspersoft.studio.field.label" value="custom_no"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="passengerName" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="passenger_name"/>
		<property name="com.jaspersoft.studio.field.label" value="passenger_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="passengerPhone" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="passenger_phone"/>
		<property name="com.jaspersoft.studio.field.label" value="passenger_phone"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="driver1Name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="driver1_name"/>
		<property name="com.jaspersoft.studio.field.label" value="driver1_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="driver1PhoneNumber" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="driver1_phonenumber"/>
		<property name="com.jaspersoft.studio.field.label" value="driver1_phonenumber"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="driver2Name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="driver2_name"/>
		<property name="com.jaspersoft.studio.field.label" value="driver2_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="driver2PhoneNumber" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="driver2_phonenumber"/>
		<property name="com.jaspersoft.studio.field.label" value="driver2_phonenumber"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="pricePerKm" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="price_per_km"/>
		<property name="com.jaspersoft.studio.field.label" value="price_per_km"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<field name="applyVehicleRemark" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="apply_vehicle_remark"/>
		<property name="com.jaspersoft.studio.field.label" value="apply_vehicle_remark"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="traffic_job_main"/>
	</field>
	<detail>
		<band height="200" splitType="Stretch">
			<staticText>
				<reportElement x="20" y="0" width="100" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[示例交通报表]]></text>
			</staticText>
			<textField>
				<reportElement x="20" y="20" width="150" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["编号: " + $F{trafficNo}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="200" y="20" width="150" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["申请时间: " + $F{createTime}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="20" y="60" width="100" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[申请人信息]]></text>
			</staticText>
			<staticText>
				<reportElement x="20" y="80" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<text><![CDATA[申请单位:]]></text>
			</staticText>
			<textField>
				<reportElement x="90" y="80" width="200" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{applyOrgName}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="310" y="80" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<text><![CDATA[申请人:]]></text>
			</staticText>
			<textField>
				<reportElement x="380" y="80" width="166" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{applyUserName}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="20" y="100" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<text><![CDATA[联系电话:]]></text>
			</staticText>
			<textField>
				<reportElement x="90" y="100" width="200" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{applyUserPhone}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="20" y="120" width="100" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[车辆信息]]></text>
			</staticText>
			<staticText>
				<reportElement x="20" y="140" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<text><![CDATA[车牌号:]]></text>
			</staticText>
			<textField>
				<reportElement x="90" y="140" width="100" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{vehiclePlateNo}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="210" y="140" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<text><![CDATA[单价:]]></text>
			</staticText>
			<textField>
				<reportElement x="280" y="140" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{pricePerKm}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="370" y="140" width="70" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<text><![CDATA[备注:]]></text>
			</staticText>
			<textField>
				<reportElement x="440" y="140" width="106" height="20" uuid="c8b715cb-26fb-43dc-ae25-58d255c6099d">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<textElement>
					<font fontName="Noto Serif SC" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{applyVehicleRemark}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>`;
        

        
        let pdfBlob = null;
        
        // 行号功能
        const jrxmlContent = document.getElementById('jrxml-content');
        const lineNumbers = document.getElementById('line-numbers');
        
        // 搜索功能
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchPrevBtn = document.getElementById('search-prev-btn');
        const searchNextBtn = document.getElementById('search-next-btn');
        const searchCaseBtn = document.getElementById('search-case-btn');
        const searchCount = document.getElementById('search-count');
        
        let searchResults = [];
        let currentSearchIndex = -1;
        let caseSensitive = false;
        
        // 搜索功能
        function performSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                clearSearch();
                return;
            }
            
            const content = jrxmlContent.value;
            const searchFlags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(escapeRegExp(searchTerm), searchFlags);
            
            searchResults = [];
            let match;
            while ((match = regex.exec(content)) !== null) {
                searchResults.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0]
                });
            }
            
            updateSearchCount();
            highlightSearchResults();
            
            if (searchResults.length > 0) {
                currentSearchIndex = 0;
                highlightCurrentResult();
                scrollToCurrentResult();
            } else {
                currentSearchIndex = -1;
            }
        }
        
        function clearSearch() {
            searchResults = [];
            currentSearchIndex = -1;
            updateSearchCount();
            clearHighlights();
        }
        
        function updateSearchCount() {
            if (searchResults.length === 0) {
                searchCount.textContent = '';
            } else {
                searchCount.textContent = `${currentSearchIndex + 1} / ${searchResults.length}`;
            }
        }
        
        function highlightSearchResults() {
            clearHighlights();
            
            if (searchResults.length === 0) return;
            
            const content = jrxmlContent.value;
            let highlightedContent = '';
            let lastIndex = 0;
            
            searchResults.forEach((result, index) => {
                highlightedContent += content.substring(lastIndex, result.start);
                highlightedContent += `<mark data-search-index="${index}">${result.text}</mark>`;
                lastIndex = result.end;
            });
            
            highlightedContent += content.substring(lastIndex);
            
            // 创建一个临时的div来处理高亮
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = highlightedContent;
            
            // 由于textarea不支持HTML，我们需要使用其他方法
            // 这里我们只更新搜索计数和当前结果位置
        }
        
        function clearHighlights() {
            // 由于textarea不支持HTML高亮，我们暂时不实现
            // 在实际应用中，可能需要使用contenteditable div或其他方法
        }
        
        function highlightCurrentResult() {
            // 由于textarea不支持HTML高亮，我们暂时不实现
            // 在实际应用中，可能需要使用contenteditable div或其他方法
        }
        
        function scrollToCurrentResult() {
            if (currentSearchIndex < 0 || currentSearchIndex >= searchResults.length) return;
            
            const result = searchResults[currentSearchIndex];
            const content = jrxmlContent.value;
            
            // 计算行号
            const textBeforeMatch = content.substring(0, result.start);
            const lineNumber = textBeforeMatch.split('\n').length;
            
            // 计算字符位置在当前行中的偏移
            const lines = textBeforeMatch.split('\n');
            const charInLine = lines[lines.length - 1].length;
            
            // 获取textarea的行高
            const lineHeight = 22; // 与CSS中的行高一致
            
            // 计算滚动位置
            const scrollTop = (lineNumber - 1) * lineHeight;
            jrxmlContent.scrollTop = scrollTop;
            
            // 设置光标位置
            jrxmlContent.focus();
            jrxmlContent.setSelectionRange(result.start, result.end);
        }
        
        function goToNextResult() {
            if (searchResults.length === 0) return;
            
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            updateSearchCount();
            highlightCurrentResult();
            scrollToCurrentResult();
        }
        
        function goToPrevResult() {
            if (searchResults.length === 0) return;
            
            currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            updateSearchCount();
            highlightCurrentResult();
            scrollToCurrentResult();
        }
        
        function toggleCaseSensitive() {
            caseSensitive = !caseSensitive;
            searchCaseBtn.classList.toggle('active', caseSensitive);
            // 不再自动执行搜索，需要用户手动点击搜索按钮
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // 搜索事件监听
        searchBtn.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                performSearch();
            }
        });
        
        searchNextBtn.addEventListener('click', () => {
            if (searchResults.length > 0) {
                goToNextResult();
            } else {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performSearch();
                }
            }
        });
        
        searchPrevBtn.addEventListener('click', () => {
            if (searchResults.length > 0) {
                goToPrevResult();
            } else {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performSearch();
                }
            }
        });
        
        searchCaseBtn.addEventListener('click', toggleCaseSensitive);
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // Ctrl+F 或 F3 聚焦搜索框
            if ((e.ctrlKey && e.key === 'f') || e.key === 'F3') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
            
            // Enter 执行搜索
            if (e.key === 'Enter' && document.activeElement === searchInput) {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performSearch();
                }
            }
            
            // Shift+Enter 也执行搜索
            if (e.key === 'Enter' && e.shiftKey && document.activeElement === searchInput) {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performSearch();
                }
            }
        });
        

        // 行号功能
        function updateLineNumbers() {
            const lines = jrxmlContent.value.split('\n');
            const lineCount = lines.length;
            
            let lineNumbersHtml = '';
            for (let i = 1; i <= lineCount; i++) {
                lineNumbersHtml += i + '\n';
            }
            
            lineNumbers.textContent = lineNumbersHtml;
        }
        
        // 初始化行号
        updateLineNumbers();
        
        // 监听文本变化和滚动
        jrxmlContent.addEventListener('input', updateLineNumbers);
        jrxmlContent.addEventListener('scroll', function() {
            lineNumbers.scrollTop = jrxmlContent.scrollTop;
        });
        
        document.getElementById('load-sample-btn').addEventListener('click', () => {
            jrxmlContent.value = sampleJrxml;
            updateStatus('已加载示例JRXML内容', 'success');
            updateLineNumbers();
            clearSearch();
        });
        
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const jrxmlContent = document.getElementById('jrxml-content').value.trim();
            
            if (!jrxmlContent) {
                updateStatus('请输入JRXML内容', 'error');
                return;
            }
            
            updateStatus('正在生成PDF...', '');
            
            try {
                const response = await fetch('http://localhost:8084/api/pdf/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: jrxmlContent
                });
                
                if (response.ok) {
                    // 成功生成PDF
                    pdfBlob = await response.blob();
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    document.getElementById('pdf-preview').src = pdfUrl;
                    document.getElementById('download-btn').disabled = false;
                    updateStatus('PDF生成成功！', 'success');
                } else {
                    // 检查响应类型是否为JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        updateStatus(`生成失败: ${errorData.message || errorData.error}`, 'error');
                        // 清空预览
                        document.getElementById('pdf-preview').src = '';
                        document.getElementById('download-btn').disabled = true;
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                
            } catch (error) {
                updateStatus(`生成失败: ${error.message}`, 'error');
                console.error('Error generating PDF:', error);
                // 清空预览
                document.getElementById('pdf-preview').src = '';
                document.getElementById('download-btn').disabled = true;
            }
        });
        
        document.getElementById('download-btn').addEventListener('click', () => {
            if (pdfBlob) {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_report.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
        
        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status';
            if (type) {
                statusElement.classList.add(type);
            }
        }
    </script>
</body>
</html>